{% extends 'base.html' %}
{% block content %}
{% load django_bootstrap5 %}
<div class="d-flex justify-content-between mt-5 row">
  <div class="col-2" style="overflow: auto; height: 400px;">
    {% for messageroom in messagerooms %}
    {% if request.user == messageroom.to_user %}
    <a class="text-decoration-none position-relative" href="{% url 'chats:detail' messageroom.pk %}"><p>{{messageroom.from_user}}<br>{{messageroom.last_message}}<br>{{messageroom.updated_at}}</p>  {% if request.user != messageroom.last_user and messageroom.count != 0  %}
        <p class="rounded-circle bg-danger fw-bold text-center text-white position-absolute top-0 end-0" style="width: 25px;">{{ messageroom.count }}</p>
        {% endif %}</a>
    
    {% else %}
    <a class="text-decoration-none position-relative" href="{% url 'chats:detail' messageroom.pk %}"><p>{{ messageroom.to_user }}<br>{{messageroom.last_message}}<br>{{messageroom.updated_at}}</p>  {% if request.user != messageroom.last_user and messageroom.count != 0  %}
        <p class="rounded-circle bg-danger fw-bold text-center text-white position-absolute top-0 end-0" style="width: 25px;">{{ messageroom.count }}</p>
        {% endif %}</a>
    {% endif %}              
    {% endfor %}
    </div>
  <div class="col-9" id="message" style="overflow: auto; height: 400px;">
    {% for message in messages %}
    {% if message.recipient_id != request.user.id %}
    <div class="d-flex justify-content-end">
      <p>{{message.create_at}}</p>
      <p>{{request.user}}</p>
      <p>{{message.content}}</p>
    </div>
    {% else %}
    <div class="d-flex justify-content-start">
      {% if request.user == room_info.to_user %}
      {{ room_info.from_user }}
      {% else %}
      {{ room_info.to_user }}
      {% endif %}
      <p>{{message.content}}</p>
      <p>{{message.create_at}}</p>
    </div>
    {% endif %}
    {% endfor %}
    <p id="to-pk" style="display: none;">{% if request.user.id == room_info.from_user_id %}{{room_info.to_user.pk}}{% else %}{{room_info.from_user.pk}}{% endif %}</p>
  </div>
  <div class="col-12 p-0 mt-3">
    <form id="message-form">
      {% csrf_token %}
      {% bootstrap_form form %}
      <div class="d-flex justify-content-end">
        {% bootstrap_button button_type='submit' content='전송' %}
      </div>
    </form>
  </div>
</div>
<div id="mename" style="display: none;">{{request.user.username}}</div>
<div id="notmename" style="display: none;">{% if request.user == room_info.to_user %}{{ room_info.from_user }}{% else %}{{ room_info.to_user }}{% endif %}</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const messageForm = document.querySelector('#message-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  const toPk = document.querySelector('#to-pk').innerText
  messageForm.addEventListener('submit', function() {
    event.preventDefault();
    axios({
      method: 'post',
      url: `/chats/${toPk}/send/`,
      headers: {'X-CSRFToken': csrftoken},
      data: new FormData(messageForm),
    })
    .then(response => {
      const message = document.querySelector('#message')
      removeAllchild(message)
      function removeAllchild(div) {
        while (div.hasChildNodes()) {
          div.removeChild(div.firstChild);
        }
      };
      const resdata = response.data.content;
      const mename = document.querySelector('#mename').innerText
      const notmename = document.querySelector('#notmename').innerText
      for (let i = 0; i < resdata.length; i++) {
        const div = document.createElement('div')
        div.className = 'd-flex';
        if (resdata[i][0] === Number(toPk)) {
          div.className += ' justify-content-end'
          const p1 = document.createElement('p');
          const p2 = document.createElement('p');
          const p3 = document.createElement('p');
          p1.innerText = `${resdata[i][2]}`;
          p2.innerText = mename
          p3.innerText = `${resdata[i][1]}`;
          div.appendChild(p1);
          div.appendChild(p2);
          div.appendChild(p3);
        }
        else {
          div.className += ' justify-content-start'
          const p1 = document.createElement('p')
          const p2 = document.createElement('p')
          const p3 = document.createElement('p')
          p1.innerText = notmename
          p2.innerText = `${resdata[i][1]}`
          p3.innerText = `${resdata[i][2]}`
          div.appendChild(p1);
          div.appendChild(p2);
          div.appendChild(p3);
        }
        message.appendChild(div)
      };
      messageForm.reset()
      message.scrollTop = message.scrollHeight;
    })
  })
  const message = document.querySelector('#message')
  message.scrollTop = message.scrollHeight;
</script>
{% endblock %}